# Maintainer: manjaro <manjaro-dev@garetech.com.au>
pkgname=lynis
pkgver=6.6.6
pkgrel="$( uname -r | cut -d\. -f1-2 )"
epoch=""
pkgdesc="Security and system auditing tool to harden Unix/Linux systems"
arch=(aarch64 x86_64)
url="https://github.com/gcsgithub/lynis.git"
license=('GPL-3.0')
groups=()
depends=(git bash)
makedepends=()
checkdepends=()
optdepends=()
provides=("${pkgname}-${pkgver}")
conflicts=("${pkgname}")
replaces=()
backup=('etc/lynis/default.prf')
options=()
install=
changelog=
source=(git+${url}#branch=soedev)
noextract=()
md5sums=("SKIP")
validpgpkeys=()

pkgver() {
    #pkgver="$( cd "${srcdir}/${pkgname}" && git describe  | cut -d\- -f1)"
    pkgver="$( cd "${srcdir}/${pkgname}" && lynis --version )"
    [ "${pkgver:0:1}" = "v" ]  && pkgver="${pkgver:1}"
    echo "${pkgver}"
}

subpackages="${pkgname}-doc ${pkgname}-bash-completion:bashcomp:noarch"


package() {
    builddir="${srcdir}/${pkgname}"

    install -Dm755 "${builddir}/${pkgname}"      "${pkgdir}/usr/sbin/${pkgname}"

    mkdir -p -m0755              "${pkgdir}/usr/share/${pkgname}"
    cp -r "${builddir}/db"       "${pkgdir}/usr/share/${pkgname}"
    cp -r "${builddir}/include"  "${pkgdir}/usr/share/${pkgname}"
    cp -r "${builddir}/plugins"  "${pkgdir}/usr/share/${pkgname}"

    mkdir -p -m0700                              "${pkgdir}/etc/${pkgname}"
    install -Dm600 "${builddir}/default.prf"     "${pkgdir}/etc/${pkgname}/default.prf"

    install -Dm600 "${builddir}/extras/${pkgname}.cron"       \
                                  "${pkgdir}/etc/cron.weekly/${pkgname}"

    install -Dm600 "${builddir}/extras/systemd/lynis.service" \
                                   "${pkgdir}"/usr/lib/systemd/system/lynis.service

    install -Dm600 "${builddir}/extras/systemd/lynis.timer"   \
                                   "${pkgdir}"/usr/lib/systemd/system/lynis.timer

    sed -i 's?ExecStart=/path/to/lynis?ExecStart=/usr/bin/lynis?' \
                   "${pkgdir}"/usr/lib/systemd/system/lynis.service
 
   # lynis-doc
    mkdir   -p -m 0755                      "${pkgdir}/usr/share/doc/${pkgname}"
    install -Dm644 ${buildir}/CHANGELOG.md  "${pkgdir}/usr/share/doc/${pkgname}/"
    install -Dm644 ${buildir}/FAQ           "${pkgdir}/usr/share/doc/${pkgname}/"
    install -Dm644 ${buildir}/README        "${pkgdir}/usr/share/doc/${pkgname}/"
    install -Dm644 "${builddir}/lynis.8"    "${pkgdir}/usr/share/man/man8/lynis.8"

}

bashcomp() {
    pkgdesc="Bash completions for ${pkgname}"
    install_if="${pkgname}=${pkgver}-r${pkgrel} bash-completion"

    mkdir -p "$subpkgdir"/usr/share/bash-completion/completions/
    install -Dm644 "${builddir}/extras/bash_completion.d/lynis"    \
                   "$subpkgdir/usr/share/bash-completion/completions/lynis"
}
